/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.mingda.action.info.neweditor;

import java.io.File;
import java.sql.SQLException;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.fileupload.DiskFileUpload;
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.FileUploadException;
import org.apache.struts.action.Action;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.ibatis.sqlmap.client.SqlMapClient;
import com.mingda.action.oa.FileUpload;
import com.mingda.common.ibatis.SqlMapper;
import com.mingda.common.ibatis.dao.InfoTAnnexDAO;
import com.mingda.common.ibatis.data.InfoTAnnex;

/**
 * MyEclipse Struts Creation date: 05-27-2009
 * 
 * XDoclet definition:
 * 
 * @struts.action validate="true"
 */
public class AnnexsaveAction extends Action {
	/*
	 * Generated Methods
	 */

	/**
	 * Method execute
	 * 
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		SqlMapClient client = SqlMapper.getSqlMapper();
		String familyId = "";
		try {
			String annexname = "";
			client.startTransaction();
			// 初始化common upload 类
			DiskFileUpload ff = new DiskFileUpload();
			ff.setSizeMax(41943040);
			ff.setSizeThreshold(4096);
			ff.setHeaderEncoding("gb18030");
			// 装载request对象
			List<FileItem> list = ff.parseRequest(request);
			// 附件类
			FileItem inchfileitem = null;
			for (FileItem item : list) {
				if (item.isFormField()) {
					if ("annexname".equals(item.getFieldName())) {
						annexname = item.getString("gb18030");
					}
					if ("familyId".equals(item.getFieldName())) {
						familyId = item.getString("gb18030");
					}
				} else {
					inchfileitem = item;
					// log.debug(inchfileitem.getFieldName()+
					// "            " +inchfileitem.getName());
				}
			}
			FileUpload fu = new FileUpload();
			String inchpath = fu.isFileExists();
			String inchpathname = "annex/"
					+ familyId
					+ "/"
					+ java.util.UUID.randomUUID().toString()
					+ inchfileitem.getName().substring(
							inchfileitem.getName().lastIndexOf("."));
			String filetype = inchfileitem.getName().substring(
					inchfileitem.getName().lastIndexOf("."));
			filetype = filetype.toLowerCase();
			String remark = "";
			if (filetype.equals(".jpg")) {
				remark = "图片";
			} else if (filetype.equals(".bmp")) {
				remark = "图片";
			} else if (filetype.equals(".png")) {
				remark = "图片";
			} else if (filetype.equals(".rm")) {
				remark = "图片";
			} else if (filetype.equals(".wmv")) {
				remark = "图片";
			} else if (filetype.equals(".avi")) {
				remark = "图片";
			} else if (filetype.equals(".mpeg")) {
				remark = "图片";
			} else {
				remark = "-1";
			}
			if ("-1".equals(remark)) {
				request.setAttribute("str", "不支持这种格式的文件");
			} else {
				// 建立文件夹
				File inchfile = new File(inchpath + "annex/" + familyId + "/");
				if (!inchfile.exists()) {
					inchfile.mkdirs();
				}
				// 存储照片
				inchfile = new File(inchpath + inchpathname);
				inchfileitem.write(inchfile);
				// log.debug(inchpath + inchpathname);
				InfoTAnnex annex = new InfoTAnnex();
				InfoTAnnexDAO annexdao = new InfoTAnnexDAO(client);
				annex.setTarget("INFO_T_FAMILY");
				annex.setAnnexname(annexname);
				annex.setFileext(filetype);
				annex.setPath(inchpathname);
				annex.setRelationid(new Integer(familyId));
				annex.setStatus("1");
				annex.setRemark(remark);
				annexdao.insert(annex);
			}
			client.commitTransaction();
		} catch (FileUploadException e) {
			e.printStackTrace();
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				client.endTransaction();
			} catch (SQLException e) {
				e.printStackTrace();
			}
		}
		ActionForward forward = new ActionForward(
				"/page/info/neweditor/annexinit.do?familyId=" + familyId);
		return forward;
	}
}